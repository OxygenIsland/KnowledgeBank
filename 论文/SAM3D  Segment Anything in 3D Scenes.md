---
title: "[[SAM3D  Segment Anything in 3D Scenes]]"
type: Reference
status: done
Creation Date: 2025-01-20 17:48
tags:
---
SAM3D 的核心思想是通过将 SAM 在 RGB 图像中预测的 2D 分割掩码投影到 3D 点云中，并通过迭代合并的方式生成整个 3D 场景的分割结果。具体步骤如下：
1. **2D 分割**：
    - 使用 SAM 对带有姿态信息的 RGB 图像进行分割，生成 2D 分割掩码。
2. **2D 到 3D 的投影**：
    - 将 2D 分割掩码投影到 3D 点云中，生成初始的 3D 分割掩码。
3. **迭代合并**：
    - 使用自底向上的合并方法，逐步合并相邻帧的 3D 分割掩码。
    - 在每一步中，采用双向合并方法，将不同帧的 3D 分割掩码逐步合并为整个 3D 场景的分割结果。
4. **可选的后处理**：
    - 可以将 SAM3D 的结果与基于 3D 场景几何信息的过分割结果进行集成，以进一步提高分割质量。
## 1、**将 SAM 分割结果映射到点云**
### 1.1 **使用 SAM 生成 2D 分割掩码**
- 对单帧 RGB 图像，使用 SAM 的自动掩码生成方法生成像素级的分割掩码。
- SAM 返回具有不同粒度的嵌套掩码：整体（whole）、部分（part）和子部分（subpart）。
- 如果一个像素被多个掩码覆盖，则选择预测 IoU（交并比）最高的掩码 ID 分配给该像素。
### 1.2 **将 2D 掩码映射到 3D 点云**
- **映射公式**：
$$
[x_i, y_i, z_i]^T = R^{-1} M^{-1} s [u_i, v_i, 1]^T - R^{-1} T,
$$
- 其中：
	- $[u_i, v_i, 1]$ 是 2D 齐次坐标。
	- $[x_i, y_i, z_i]$ 是投影后的 3D 齐次坐标。
	- $M$ 是相机的内参矩阵。
	- $R$ 和 $T$ 是从相机外参矩阵中获取的旋转矩阵和平移矩阵。
	- $s$ 是一个缩放因子。
- **实现**：
    - 通过相机的外参和内参矩阵，将 2D 图像中的像素点投影到 3D 点云中，生成初始的 3D 分割掩码。
### 1.3 **对点云掩码进行下采样**
- **操作**：
    - 使用 **grid pooling** 方法对点云掩码进行下采样。
- **目的**：
    - 减少点云的分辨率，同时保留重要的分割信息。
## 2、 **双向合并相邻帧的 3D 分割结果**

### 2.1 输入数据
  - 两个相邻帧的点云 $X^1 = \{x_1^1, x_2^1, \cdots, x_m^1\}$ 和 $X^2 = \{x_1^2, x_2^2, \cdots, x_n^2\}$，其中 $m$ 和 $n$ 分别是 $X^1$ 和 $X^2$ 中的点数。
  - 两个点云之间的对应关系映射 $M$。
### 2.2 **双向合并方法**
#### 步骤 1: 计算对应关系
计算点云的对应关系是通过使用 pointops.knn_query 函数进行最近邻搜索，找到$X^1$中每个点在$X^2$中的最近邻点。
  - 计算点云 $X^1$ 和 $X^2$ 之间的对应关系映射 $M$。这个映射$M$就是两个点云的索引的对应关系
  - 如果点 $x_i^1$ 和 $x_j^2$ 是对应点，则 $(i, j) \in M$。
#### 步骤 2: 查找相同掩码的点
根据映射关系和 $X^1$ 中的每个掩码 ID寻找 $X^1$ 中的每个掩码 ID在 $X^2$ 的对应点，并统计数量
  - 对于 $X^1$ 中的每个掩码 ID $m$，找到 $X^1$ 中具有相同掩码 ID 的点集 $Q^1$。
  - 统计 $Q^1$ 中的点数 $\sigma_m^1$。
#### 步骤 3: 查找对应点
  - 利用对应关系映射 $M$，找到 $Q^1$ 中点在 $X^2$ 中的对应点集 $Q^2$。
#### 步骤 4: 统计掩码重叠
  - 对于 $Q^2$ 中的每个掩码 ID $n$，统计 $Q^2$ 中具有掩码 ID $n$ 的点数 $\sigma_{mn}^{1-2}$。
  - 统计 $X^2$ 中具有掩码 ID $n$ 的点数 $\sigma_n^2$。
#### 步骤 5: 合并掩码
- **条件：**
  - 如果 $\sigma_{mn}^{1-2} > \delta \times \min(\sigma_m^1, \sigma_n^2)$（其中 $\delta$ 是阈值，实验中设置为 0.5），则认为掩码 $m$ 和掩码 $n$ 高度重叠。
- **操作：**
  - 将 $X^2$ 中掩码 ID 为 $m$ 的点的掩码 ID 更新为 $n$。
#### 步骤 6: 对称处理
  - 对 $X^2$ 中的每个掩码 ID，重复上述步骤，查询 $X^1$ 中的点和掩码 ID。

## 3、**自底向上迭代合并**
![[Pasted image 20250121160257.png|500]]
### 3.1 初始化
- **输入：**
  - 局部点云 $X_0^1, X_0^2, \cdots, X_0^K$，其中 $K$ 是场景中的总帧数。
### 3.2: 逐层合并
  - 将相邻帧的点云 $X_0^{2i}$ 和 $X_0^{2i+1}$ 合并为一个新的点云 $X_1^i$。 (0,1)、(2,3)、(4,5)、(6,7)类似这样合并
  - 重复这个过程，直到所有点云合并为一个全局点云 $X_{\lceil \log_2 K \rceil}^0$。
- **数学表示：**
  $$
  X_{t+1}^i = X_t^{2i} \oplus X_t^{2i+1},
  $$
  其中：
  - $\oplus$ 表示双向合并操作。
  - $X_t^{2i}$ 和 $X_t^{2i+1}$ 是第 $t$ 层的相邻点云。
  - $X_{t+1}^i$ 是第 $t + 1$ 层的合并结果。
### 3.3: 双向合并与下采样
  - 在每一步合并中，使用双向合并方法合并相邻点云。
  - 合并后，使用 grid pooling 方法对点云进行下采样，以减少计算复杂度。
## 4、**与过分割结果集成**
### **4.1 过分割掩码的生成**
- 使用基于法向量的图割方法（normal-based graph cut method）生成 3D 场景的过分割掩码。
- **输入**：
    - 3D 场景的几何信息（如点云的法向量）。
- **输出**：
    - 过分割掩码，即基于几何信息的分割结果。
### **4.2 SAM3D 分割掩码的生成**
- 使用 **Segment-Anything Model (SAM)** 从 RGB 图像的语义和边缘信息生成分割掩码。
- **输入**：
    - RGB 图像及其语义和边缘信息。
- **输出**：
    - SAM3D 生成的点云分割掩码。
### **4.3 掩码集成**
- 使用**双向合并方法**，将 SAM3D 生成的分割掩码与过分割掩码进行集成。生成更高质量的分割掩码。
### **4.4 集成掩码的优势**
- **结合几何与语义信息**：
    - 集成掩码同时利用了 3D 几何信息和 RGB 语义信息，能够提供更精细和准确的分割结果。
- **提高分割质量**：
    - 实验结果表明，集成掩码的分割质量优于单独使用几何信息或语义信息的分割结果。