Klipper 是一种开源的3D打印机固件，旨在通过将高性能计算任务转移到外部计算设备（如 Raspberry Pi）上来提升3D打印机的性能和功能。与传统的3D打印机固件不同，Klipper 利用主板和外部计算设备的协同工作，实现更高效、更精确的控制。以下是 Klipper 的一些主要特点和优势：

## 1. Klipper 的主要特点
1. **分布式计算**：
    
    - Klipper 将复杂的计算任务（如运动规划和温度控制）交给外部计算设备处理，而主板仅执行低级的实时任务。
    - 这种架构减轻了主板的负担，提升了打印性能和精度。
2. **快速步进率**：
    
    - Klipper 能够支持非常高的步进频率，这对于使用高步距电机和实现高速度打印尤为重要。
    - 支持高达100kHz以上的步进频率，远高于传统固件的能力。
3. **先进的运动控制**：
    
    - 提供高级的运动控制算法，如平滑加速度控制和压力推进补偿。
    - 这些算法能够显著提高打印质量，减少振动和表面缺陷。
4. **可扩展性和模块化设计**：
    
    - Klipper 支持多主板配置，可以通过添加额外的主板来控制更多的电机和外设。
    - 用户可以根据需要扩展系统，以支持更复杂的打印任务和功能。
5. **易于配置和调试**：
    
    - 使用简单的文本配置文件进行设置，用户可以方便地调整参数和配置。
    - 支持通过网络接口（如 OctoPrint）进行远程监控和调试，提供便利的操作体验。
6. **快速固件更新**：
    
    - 由于大部分计算任务在外部计算设备上进行，更新固件通常只需重新启动外部设备，无需频繁刷写主板固件。
## 2. Klipper 全家桶
"Klipper 全家桶" 这个词语一般指的是在使用 Klipper 固件时，搭配的一整套软件和硬件工具，使得3D打印体验更加完整和高效。这通常包括 Klipper 固件本身，以及一些常用的配套软件和硬件，如 OctoPrint、Mainsail、Fluidd 等。以下是一些常见的组成部分：
### 1. **Klipper 固件**
- 核心固件，安装在3D打印机的主板上，将高性能计算任务转移到外部计算设备上进行处理。
### 2. **外部计算设备**
- 通常使用 Raspberry Pi 或类似的小型计算机，用于运行 Klipper 主程序以及其他配套软件。
### 3. **OctoPrint**
- 一个开源的3D打印机服务器软件，通过网络接口允许用户远程控制和监控3D打印机。
- 支持丰富的插件系统，能够实现打印管理、摄像头监控、耗材管理等功能。
### 4. **Mainsail**
- 专为 Klipper 设计的 Web 用户界面，提供直观的控制面板和实时监控功能。
- 界面简洁，操作方便，集成了许多高级功能。
### 5. **Fluidd**
- 另一个针对 Klipper 的 Web 用户界面，注重用户体验和界面美观。
- 提供实时状态监控、打印控制、配置管理等功能。
### 6. **Moonraker**
- Klipper 的 API 服务器，提供与 Web 界面和其他外部应用程序的通信接口。
- 支持与 Mainsail 和 Fluidd 等界面协同工作，实现全面的打印管理和控制。
### 7. **KlipperScreen**
- 一个适用于触摸屏的用户界面，安装在 Raspberry Pi 上，通过触摸屏直接控制和监控3D打印机。
- 提供便捷的本地操作方式，适合不想依赖网络接口的用户。
### 8. **摄像头**
- 配合 OctoPrint 或 Mainsail/Fluidd 使用，用于实时监控打印过程。
- 支持录像和快照功能，方便远程查看打印状态和解决问题。
可以安装MJPG-Streamer软件，MJPG-Streamer是一种开源软件，用于将实时摄像头视频流转换为 Motion JPEG 格式，并通过 HTTP 协议传输。它通常用于3D打印机、机器人和其他嵌入式系统中，以实现远程视频监控。MJPG-Streamer 的主要特点包括高效的视频处理、低延迟以及简单的配置和使用。
### 9. **额外的传感器和扩展**
- 如自动调平传感器（BLTouch 等）、热敏电阻、加速度传感器等，用于提高打印精度和质量。
- 通过 Klipper 的配置文件进行设置和管理，增加打印机的功能和可靠性。
## 3. Klipper配置
Klipper 的配置文件是一个关键部分，它用于定义和设置3D打印机的各种参数和特性。配置文件通常是一个文本文件，名为 `printer.cfg`，用户可以根据自己的打印机型号和需求进行编辑。下面讲一下一些需要配置的地方
### 3.1 X、Y、Z 、E电机参数配置
1). X和Y轴脉冲设置，只需要设置细分、同步轮周长、电机转一圈的脉冲数。
![[Pasted image 20240711221100.png]]
**microsteps**: 设置电机的微步数。例如，16 表示将每一步细分为16个微步。
**rotation_distance**: 电机每转一圈所移动的距离，这个距离也可以认为是同步轮的周长，单位为毫米。
**full_steps_per_rotation**: 每转一圈的全步数。标准步进电机为200（1.8度），高精度步进电机为400（0.9度）。

2). Z轴电机脉冲设置，Z轴电机的脉冲设置分两种情况，当机器的Z轴是丝杆时，同步轮周长的参数设置为丝杆的导程，当Z轴为同步轮与皮带时，则Z轴设置为同步轮的周长和齿轮比。
![[Pasted image 20240711221600.png]]
**gear_ratio**: 齿轮比，表示电机与驱动轴之间的传动比，例如 80:16。这个指的就是voron2.4电机底座的传动比
3). 挤出机脉冲设置，当挤出机齿轮没有齿轮比时，设置挤出机次齿轮的周长即可，当用齿轮比的挤出机还需要设置齿轮比。
![[Pasted image 20240711222125.png]]
**rotation_distance**: 电机每转一圈所移动的距离，单位为毫米。
**gear_ratio**: 齿轮比，表示电机与驱动轴之间的传动比
### 3.2 归零限位和电平
X、Y的限位pin分别是`PA14、PA15`，Zmin的限位是`PB15`,Zmax的限位是`PB14`，取反电平，在pin前加`！`。
![[Pasted image 20240711223258.png]]
![[Pasted image 20240711223309.png]]
- 如果限位开关的信号需要反转（即逻辑电平取反），在引脚名称前加一个感叹号（`!`）。
- 这通常是因为不同的限位开关在触发时可能输出高电平（逻辑1）或低电平（逻辑0）。取反电平的设置可以确保限位开关的逻辑正确。
### 3.3 归零电机方向配置
![[Pasted image 20240711224443.png]]
当归零的方向为往最小的方向时，`homing_positive_dir:false`
当归零方向为往最大方向时，`homing_positive_dir:true`
### 3.4 TMC驱动 UART模式配置

将TMC驱动前面的#去掉为配置为uart模式，不去掉则为屏蔽TMC UART
![[Pasted image 20240711224530.png]]
![[Pasted image 20240711224540.png]]
TMC（Trinamic Motion Control）驱动器的UART模式指的是一种通过UART（通用异步收发传输）通信接口来控制和配置驱动器的工作模式。通常情况下，3D打印机或其他机械设备中的驱动器通过步进/方向接口或SPI（串行外设接口）与主控板通信，但UART模式则是通过更复杂和灵活的串行通信协议实现的，其特点和优势如下：
1. **高级控制功能**：UART模式允许主控板通过UART接口直接与驱动器通信，可以对驱动器进行更精细的控制和配置。
    
2. **参数调整和监控**：通过UART，可以实时读取和调整驱动器的参数，如电流限制、微步设置、步进模式等，这些通常需要通过其他接口较为复杂或无法实现。
    
3. **故障检测和反馈**：驱动器可以通过UART模式向主控板发送详细的状态信息和故障诊断，有助于实时监控和故障排除。
    
4. **固件升级**：一些驱动器支持通过UART进行固件升级，使得驱动器的功能和性能可以随着时间而改进。
    
5. **电缆简化**：相较于传统的步进/方向信号线和SPI接口，UART通常只需要一对数据线（TX和RX），使得电缆布线更为简单。
### 3.5 机器类型配置

机器类型分别为cartesian（一般机型）、corexy（corexy机型）、delta（三角洲机型），根据自己的机器进行设置。
![[Pasted image 20240711224901.png]]
### 3.6 手动调平配置

在配置文件中增加手动调平的各点的位置
```[bed_screws]
 screw1:20,20 
 screw2:20,290 
 screw3:290,20
 screw4:290,290
```
voron 2.4的热床应该是没有手动调平点点，所以不需要配置
### 3.7 自动调平传感器配置（传感器为3Dtouch)

1、信号配置，白线是3dtouch的信号线，黄线是3dtouch的舵机控制线），舵机控制线接到主板上的`PB14/PB15`接口，信号线接到主板的`PA8`。
```
[bltouch]
sensor_pin:!PB14
control_pin:PA8
x_offset: 0
y_offset: 25.0
z_offset: 0.30
speed: 10.0
samples: 2
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.05
samples_tolerance_retries: 1
```
3D Touch 是一种常用于3D打印机自动调平的传感器，它基于电容原理工作，通常被称为自动床调平传感器或触碰传感器。以下是关于3D Touch的一些主要特点和工作原理：

1. **自动调平功能**：3D Touch 通过触碰打印床表面来检测各个调平点的高度，从而实现自动调平功能。这有助于确保打印床在不同区域的高度一致性，提高打印质量和精度。
    
2. **高精度检测**：传感器能够高精度地检测打印床表面的高度差异，通常能够检测到微小的高度变化，以便进行精确的高度调整。
    
3. **适用性广泛**：3D Touch 适用于大多数FDM（熔融沉积）类型的3D打印机，可以与多种不同的控制主板和固件兼容，如Marlin、Repetier、Smoothieware等。
- **电容检测**：3D Touch 使用电容传感器来探测打印床表面的高度。当传感器接触到打印床时，电容的值会发生变化，传感器通过测量这种变化来确定打印床的高度位置。
- **触发信号**：一旦传感器检测到打印床的高度，它会发送信号给主控板。主控板根据接收到的信号来调整打印头的Z轴位置，以补偿打印床上的高度差异。
### 3.8 自动调平传感器配置(传感器为PL08N)
信号配置，信号接到主板上的z_min的接口PB15。
```
[probe]
pin:!PB15
x_offset: 0
y_offset: 25.0
z_offset: 0.30
speed: 10.0
samples: 2
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.05
samples_tolerance_retries: 1
```
`注意：[bltouch]和[probe]不能同时配置，配置时只能选择其中一个`。
PL08N是一种接近传感器，通常用于工业自动化和机器人应用中，而不是用于3D打印机的自动调平。这种类型的传感器可以用来检测物体的接近或远离，而不涉及床面的高度测量和调整。
1. **工作原理**：PL08N传感器基于红外线的反射测量原理。它发射红外光束，并通过检测反射回来的光信号来判断物体与传感器之间的距离。
    
2. **检测范围**：PL08N通常具有较短的检测范围，一般在几厘米到数十厘米之间，适合近距离的物体检测。
    
3. **用途**：在工业和机器人应用中，PL08N可以用于检测物体的存在、定位和距离测量。例如，在自动化生产线上，它可以用来检测零件的位置或者机器人手臂的位置控制。
    
4. **电气特性**：PL08N通常使用5V直流电源供电，并通过数字输出或模拟输出来传递检测到的信息。
    
- **精度和分辨率**：PL08N通常不具备足够的精度和分辨率来测量打印床上微小的高度差，这是自动调平所需的关键能力。
    
- **应用场景**：PL08N更适合于检测物体的存在和位置，而不是进行精确的表面高度测量和调整。
### 3.9 多Z自动校准调平配置（VORON V2.4)
多Z自动校准调平，通过调整多个Z轴（通常是四个）来确保它们在不同位置的高度一致性。需要在printer.cfg的文件中增加以下代码，探测点的位置根据机器的尺寸范围设置，4个探测点分别对应4Z的位置。
```
[quad_gantry_level]
gantry_corners:
	-58,-7
    308,318
##	Probe points
points:
	10,10         #调平探测第一点
	10,200        #调平探测第二点
	220,200       #调平探测第三点
	220,10        #调平探测第四点
speed: 80         #调平速度
horizontal_move_z: 10 #调平中Z抬高高度
retries: 1            #重复次数
retry_tolerance: 0.05  #重复允许最大偏差
max_adjust: 30         #Z最大调整位置
```
**gantry_corners**: 指定了机架的四个角的坐标。在这里，左上角的坐标是 (-58, -7)，右下角的坐标是 (308, 318)。这些坐标通常用于确定打印机的边界和安全区域。
Probe points 部分定义了用于调平探测的几个点的坐标。
**points**: 指定了四个探测点的坐标。每个点的坐标表示打印床上的位置，以毫米为单位。例如，(10, 10) 表示第一点在 X=10mm，Y=10mm 的位置。

Voron 2.4的4Z位置如下：
![[Pasted image 20240711231133.png]]
接下来在配置文件中添加1个G-Code 宏指令，在配置文件中找到适当的位置（通常是文件底部）

在配置文件中增加多Z自动调平指令配置，进行自动调平，可在Fluidd界面上发送指令G32或在屏幕上点击按钮"Configuration"→"Bed level"。
```
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR      #清除调平数据
    G28
    QUAD_GANTRY_LEVEL   #多Z自动校准
    G28
```
### 3.10 线性补偿自动调平配置
通过在打印床表面定义一个网格，然后在预设的多个点上测量和调整每个点的高度，以创建一个平整的打印表面。配置如下：
```
[bed_mesh]
speed:50                #调平速度
horizontal_move_z:50   #调平中Z抬高高度
mesh_min:20,50        #探测点最小位置
mesh_max:170,200      #探测点最大位置
probe_count:3,3       #调平点数
```
在配置文件中增加多线性调平（bed mesh leveling）指令配置，进行自动调平，可在Fluidd界面上发送指令G29或在屏幕上点击按钮"Configuration"→"Bed level"。
```
[gcode_macro G29]
gcode:
    BED_MESH_CLEAR      #清除调平数据
    G28    
    BED_MESH_CALIBRATE  #自动调平
    BED_MESH_PROFILE SAVE=name #保存调平数据
    SAVE_CONFIG
    BED_MESH_PROFILE LOAD=name #加载调平数据
```
### 3.11 z_safe_homing配置
在配置文件中增加z_safe_homing的配置
```
[safe_z_home]
home_xy_position: 115,115 # x、Y归零位置
speed: 100
z_hop: 10                 # Move up 10mm
z_hop_speed: 5
```
需要在stepper_z的调平配置项把enstop_pin改为z_virtual_enstop
```
[stepper_z]
endstop_pin:probe:z_virtual_endstop 
```
在3D打印机的Klipper固件中，虚拟Z轴终点（Virtual Z Endstop）是一种通过软件模拟的Z轴终点位置。它不依赖于物理的机械开关或传感器来触发，而是根据软件中预设的逻辑条件来确定Z轴的位置。这使得可以根据打印机的特定需求和配置来动态调整Z轴的终点位置。
